## 프록시 패턴
- 데코레이터 패턴과 마찬가지로 객체의 기능을 확장함
- 데코레이터는 추가적인 동작을 할 지언정 요청한 동작은 항상 그대로 수행함
- 하지만 프록시는 어떤 동작을 요청했을 때 완전히 다른 식으로 동작할 수 있음
- 값비싼 객체가 무엇인가는 2장에서 생성 패턴을 배울 때 이미 설명함
- 예를들어 네트워크 자원에 접근하거나 생성 시간이 오래걸리는 객체는 값비싼 객체임

## 예
- '웃긴 고양이'라는 앱을 만든다고 하자
- 이 앱에는 매일 웃긴 고양이 사진이 한장 올라온다.
- 홈페이지와 모바일 앱에서 사용자는 수천장의 웃긴 고양이 사진을 볼 수 있다.
- 그 중 하나를 클릭하거나 터치하면 사진이 전체화면으로 표시됨
- 네트워크를 통해 고양이 사진을 받아 오는 것은 매우 값비싼 동작이며 메모리도 많이 필요하다.
- 특히 저녁 식사 후 디저트에 코를 박고 있는 고양이 사진이면 더욱 오래 걸릴 것
- 그래서 사진을 요청했을 때 원본 이미지를 딱 한번만 받아 오기를 원함
- 가족이나 친구들에게 보여주기 위해 여러번 사진을 요청하는 경우에도 똑같은 사진을 여러번 받아오지 않고 한 번만 받도록 하는 것

### 프록시 패턴의 핵심
- 사진을 한번 받는 것은 피할 수 없다.
- 하지만 두번째 사진을 요청했을 땐 다시 네트워크를 통해 사진 파일을 가져오는 대신 메모리에 캐시돼 있는 사진을 전달할 것임
- 이게 프록시 패턴의 핵심이다.
- 기대하는동작(네트워크를 통해 사진 파일을 받아 오는 것)을 그대로 하는 대신 조금 꾀를 부려서 이미 준비된 사진을 전달하는 것
- 마치 김밥천국에 가서 돈가스를 시켯는데 2분도 안돼 음식이 나온 것과 같음
- 하지만 음식은 차갑게 식어있다. 조금 전에 누군가가 돈가스를 시켰다가 샐러드가 마음에 들지 않아서 그냥 간것과 같음
- 이런 기능을 작성하려면 매우 복잡한 로직이 필요해 보이지만 데코레이터 패턴을 배웠다면 코틀린으로 쉽게 짤 수 있음
- 어떤 목적을 달성하기 위해 작성해야 하는 반복적인 코드를 코틀린은 크게 줄여주기 대문이다.
```
data class CatImage(val thumbnailUrl: String, val url:String) {
    val image: ByteArray by lazy {
        // 이미지를 바이트 배열로 읽는다
        URL(url).readBytes()
    }
}
```
- 앞서 다른 맥락에서 by 키워드가 사용되는 것을 본 적이 있음
- 인터페이스의 구현을 다른 클래스에 위임하는 경우임
- 이번에 사용된 by키워드는 필드 초기화가 나중에 일어나도록 위임하는 역할을 수행함
- 여기서 쓰인 lazy라는 함수는 코틀린 표준 라이브러리에 있는 위임함수 중 하나이다
- image속성을 처음 호출하면 코드 블록이 실행되고 그 결과가 image속성에 저장됨
- 이후의 호출은 그냥 속성에 저장된 값을 반환함
- 간혹 프록시 디자인 패턴을 3가지 하위 패턴으로 분류하기도 하ㅣㅁ
  - 가상 프록시 : 게으른 방식으로 결과를 캐시함
  - 원격 프록시 : 원격지의 자원에 접근
  - 보호 프록시 또는 접근 제어 프록시 : 인가되지 않은 접근을 거부
- 앞의 예제 코드는 가상 프록시 또는 가상 프록시와 원격 프록시의 조합이라고 할 수 있음

### Lazy 위임함수
- 두 스레드가 동시에 image 속성을 초기화하려고 하면 어떻게 되는지 궁금할 수 있음
- 기본적으로 Lazy() 함수는 호출을 동기화함
- 즉 두 스레드 중 한 스레드만 코드 블록을 실행할 수 있고, 나머지 스레드는 실행이 완료될 때 까지 기다려야 함
- 만약에 lazy 블록을 동시에 실행해도 괜찮다면(예를 들어서 그다지 값비싼 동작이 아니라면) lazy(lazyThreadSafetyMode.PUBLICATION)을 사용할 수 있음
- 성능이 최우선 고려사항이면 두 스레드가 같은 블록을 절대로 동시에 실행하지 않는다는 것을 보장할 수 있다면 LazyThreadSafetyMode.NONE을 사용할 수도 있음
- 이 경우에 lazy 블록은 스레드 안전하지 않음
- 프록시 패턴과 위임을 적절히 사용하면 많은 복잡한 문제를 해결할 수 있음
- 책 뒷부분에서 확인할것